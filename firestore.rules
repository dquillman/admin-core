rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Is the user authenticated?
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: Is the user an admin according to their profile?
    function isAdmin() {
      return isAuthenticated() && 
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
              isBootstrapUser();
    }
    
    // Helper: Is this the document for the current user?
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper: Is this the Hardcoded Bootstrap Admin? (God Mode)
    function isBootstrapUser() {
      return isAuthenticated() && request.auth.token.email == 'dquillman2112@gmail.com';
    }

    /**
     * Users Collection
     * - Only owners or admins can read user profiles.
     * - Owners can create their profile but NOT set their own role/disabled status.
     * - Only admins can update privileged fields (role, disabled).
     * - EXCEPTION: Bootstrap User can self-promote.
     */
    match /users/{userId} {
      // Broadened for Guest/Anon support (Client needs to read/write without Auth)
      allow read, write: if true; 
    }
    
    // ... (Existing audit logs) ...

    /**
     * Operational Data (Quiz Attempts)
     * - User can read their own for daily usage.
     * - Broadened to allow Guest Usage (client-side limit tracking)
     */
    match /quizAttempts/{attemptId} {
      allow read, write: if true;
    }

    /**
     * Admin Audit Logs (Global)
     * - Only admins can read/write
     */
     match /admin_audit/{docId} {
        allow read, write: if isAdmin();
     }

    /**
     * Marketing Assets (Messaging)
     * - Public Read for Landing Page/App Copy.
     * - Admin Write.
     */
    match /marketing_assets/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * App-Scoped Collections (apps/{appId}/...)
     */
    match /apps/{appId} {
      allow read: if true; // Public Config Read (Required for Client App)
      
      // App Config (Public Read for Client)
      match /config/{docId} {
        allow read: if true;
        allow write: if isAdmin();
      }
      
      // Sources (Admins Only - Backend Use)
      match /sources/{docId} {
        allow read, write: if isAdmin();
      }
      
      // Audit Logs (Admins Only)
      match /audit/{docId} {
        allow read: if isAdmin();
        // Allow creation by any admin (via logAdminAction)
        allow create: if isAdmin() && request.resource.data.adminUid == request.auth.uid;
      }
    }

    match /conversion_events/{event} {
      allow read: if isAdmin();
    }

    /**
     * Content Management (Legacy/Global Context)
     * - Questions and Exams read-only for public (Landing Page/App Content).
     * - Admin Write.
     */
    match /questions/{questionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /exams/{examId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * User Sessions (Tester Activity)
     * - Admins can read all session data.
     * - Public/Web app access is handled by the web app's own rules (write-only for owner).
     * - Here we only need to expose reading for the Admin Core UI.
     */
    match /user_sessions/{sessionId} {
      // Admin: Full access
      allow read, list: if isAdmin();
      
      // Public/Guest Access (Fixes "Permission Denied" for anon sessions)
      allow create: if true;
      allow read: if true;
      allow update: if true;
    }

    /**
     * Public Bug Reporting / Issue Tracking
     * - Authenticated users can create issues.
     * - Only admins can read/manage them.
     */
    /**
     * Public Bug Reporting / Issue Tracking
     * - Authenticated users can create issues.
     * - Users can read their own issues (fixes snapshot listener).
     * - Admins can read/manage all.
     */
    /**
     * Public Bug Reporting
     * - Handle "issues" collection (Real Client).
     */
    /**
     * Public Bug Reporting
     * - Handle "issues" collection (Real Client).
     * - Allow Auth Read (Client likely queries without filter).
     */
    /**
     * Public Bug Reporting
     * - "issues" is the active client collection.
     * - Allow Owner Read for snapshot listeners (filtering required by client).
     */
    match /issues/{issueId} {
      allow create: if true; // Public generation (Anon/Guest support)
      allow read: if true;   // Public read (Fixes client snapshot errors)
      allow update, delete: if isAdmin();
    }
    
    // Legacy / Admin Test Path
    match /reported_issues/{issueId} {
      allow create: if request.auth != null;
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    match /smart_questions/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * Operational Data (Quiz Attempts)
     * - User can read their own for daily usage.
     */
    match /quizAttempts/{attemptId} {
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    /**
     * Admin Core Exclusive Collections
     * - Strictly Admin Only
     */
    match /weekly_reviews/{reviewId} {
      allow read, write: if isAdmin();
    }

    match /founder_briefings/{briefingId} {
      allow read, write: if isAdmin();
    }

    match /decisions/{decisionId} {
      allow read, write: if isAdmin();
    }

    match /simulations/{simId} {
      allow read, write: if isAdmin();
    }

    match /admin_config/{docId} {
      allow read, write: if isAdmin();
    }

    // Default: Deny all other access
    match /{document=**} {
      allow read, write: if true; // NUCLEAR DEBUG MODE
    }
  }
}
